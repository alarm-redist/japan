---
title: "広島県　衆議院議員選挙　小選挙区　区割り改訂案"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)

pref_code <- 34
pref_name <- "hiroshima"
```

```{r load data, include=FALSE}
load(paste("data-out/pref/",
            as.character(pref_code),
            "_",
            as.character(pref_name),
            "_data",
            ".Rdata",
            sep = ""))
```

## 基礎データ
```{r status quo, include = FALSE}
sq_data <- c("7→6", "1.612", "1.724", "1.693", "1.738", 
             "4(江田島市、尾道市、東広島市、三原市)",
             "なし")
sq_data <- as.data.frame(sq_data)

row.names(sq_data) <- c("小選挙区の定数の増減", 
                        "都道府県内の一票の格差 (2015)",
                        "都道府県内の一票の格差 (2020)", 
                        "対鳥取２区の一票の格差 (2015)",
                        "対鳥取２区の一票の格差 (2020)", 
                        "現行の区割りで分割されている市区町村",
                        "現行の区割りで分割されている郡")
colnames(sq_data) <- c("")
```

```{r knit table, echo = FALSE}
knitr::kable(sq_data)
```

## アルゴリズム設定
* 各選挙区の人口を、一票の格差が1となる理論上の選挙区人口の**±0.10**倍以内に設定
* 市区町村を分割しない案、人口が最大の市区町村を分割する案それぞれ25000案を作成
* 飛び地が生じた案を棄却した結果得た区割り案の数は、市区町村を分割しない案に関しては`r length(functioning_results_0$index) `、人口が最大の市区町村を分割する案に関しては`r length(functioning_results_1$index) `

### 県特有の設定
* 飛び地が生じるのを防ぐために、安芸郡と広島市安芸区が異なる選挙区に属するような案は棄却
* 飛び地が生じるのを防ぐために、竹原市及び呉市が東広島市と異なる選挙区に属するような案は棄却

## 市区町村を分割しない案 : 最適解
一票の格差:`r round(results_0[optimal_0,]$max_to_min, digits = 3) `

```{r optimal plan (0 split), echo = FALSE}
ggplot() +
  geom_sf(data = optimal_boundary_0, aes(fill = factor(district))) +
  scale_fill_manual(values = c("firebrick4", "lightgoldenrod4", "darkorchid4", 
                               "green4", "blue4", "lightcyan3")) +
  geom_sf(data = mun_boundary, fill = NA, color = "grey27", lwd = 0.4) +
  geom_sf(data = gun_boundary, fill = NA, color = "black", lwd = 1.0) +
  labs(caption = "太線:郡の境界") +
  ggthemes::theme_map(base_family = "HiraginoSans-W3") +
  theme(legend.title = element_blank(), legend.position = "None")
```

## 最大市区町村の分割を許容する案 : 最適解
人口が最大の市区町村：福山市

一票の格差：`r round(results_1[optimal_1,]$max_to_min, digits = 3) `

```{r optimal plan (1split), echo = FALSE}
ggplot() +
  geom_sf(data = optimal_boundary_1, aes(fill = factor(district))) +
  scale_fill_manual(values = c("firebrick4", "lightgoldenrod4", "darkorchid4", 
                               "green4", "blue4", "lightcyan3")) +
  geom_sf(data = mun_boundary, fill = NA, color = "grey27", lwd = 0.4) +
  geom_sf(data = gun_boundary, fill = NA, color = "black", lwd = 1.0) +
  labs(caption = "太線:郡の境界") +
  ggthemes::theme_map(base_family = "HiraginoSans-W3") +
  theme(legend.title = element_blank(), legend.position = "None")
```

# 共起分析
* 市区町村分割を許容しない設定で得た区割り改訂案の中で、飛び地がないもののうち、一票の格差が下位10%の案を抽出
* 同じ色の市区町村同士は同じ選挙区に属する傾向が大きい
* 同じ色の市区町村の中でも、濃い色の市区町村の方が、同じ選挙区に属する傾向が大きい

```{r co-occurrence, echo = FALSE}
# Match membership data with map object
pref_0_membership <- cbind(pref_0, cooc_ratio, pref_membership_0)
pref_0_membership_1 <- pref_0_membership %>% dplyr::filter(membership == 1)
pref_0_membership_2 <- pref_0_membership %>% dplyr::filter(membership == 2)
pref_0_membership_3 <- pref_0_membership %>% dplyr::filter(membership == 3)
pref_0_membership_4 <- pref_0_membership %>% dplyr::filter(membership == 4)
pref_0_membership_5 <- pref_0_membership %>% dplyr::filter(membership == 5)
pref_0_membership_6 <- pref_0_membership %>% dplyr::filter(membership == 6)

# Co-occurrence plot
ggplot() +
  geom_sf(data = pref_0_membership_1, aes(fill = cooc_ratio), show.legend = FALSE) +
  scale_fill_gradient(low = "firebrick1", high = "firebrick4") +

  ggnewscale::new_scale_fill() +
  geom_sf(data = pref_0_membership_2, aes(fill = cooc_ratio), show.legend = FALSE) +
  scale_fill_gradient(low = "lightgoldenrod1", high = "lightgoldenrod4") +

  ggnewscale::new_scale_fill() +
  geom_sf(data = pref_0_membership_3, aes(fill = cooc_ratio), show.legend = FALSE) +
  scale_fill_gradient(low = "darkorchid1", high = "darkorchid4") +

  ggnewscale::new_scale_fill() +
  geom_sf(data = pref_0_membership_4, aes(fill = cooc_ratio), show.legend = FALSE) +
  scale_fill_gradient(low = "blue1", high = "blue4") +

  ggnewscale::new_scale_fill() +
  geom_sf(data = pref_0_membership_5, aes(fill = cooc_ratio), show.legend = FALSE) +
  scale_fill_gradient(low = "lightcyan1", high= "lightcyan3") +

  ggnewscale::new_scale_fill() +
  geom_sf(data = pref_0_membership_6, aes(fill = cooc_ratio), show.legend = FALSE) +
  scale_fill_gradient(low="green1", high="green4") +

  geom_sf(data = mun_boundary, fill = NA, color = "grey27", lwd = 0.4) +
  geom_sf(data = gun_boundary, fill = NA, color = "black", lwd = 1.0) +

  labs(caption = "太線:郡の境界") +
  ggthemes::theme_map(base_family = "HiraginoSans-W3") +
  theme(legend.title = element_blank(), legend.position = "None")
```

