---
title: "広島県　衆議院議員選挙　小選挙区　区割り改訂案"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(gt)

pref_code <- 34
pref_name <- "hiroshima"
```

```{r load data, include=FALSE}
load(paste("data-out/pref/",
            as.character(pref_code),
            "_",
            as.character(pref_name),
            "_data",
            ".Rdata",
            sep = ""))
```

```{r supplemental for now}
# to be removed once we use updated .r scripts
sq_max_to_min <- 	1.724
sq_max_to_tottori2 <- 1.738
sq_mun_splits <- 4
sq_gun_splits <- 0
sq_koiki_splits <- 3
tottori_2 <- 274160
```


# 基礎データ
```{r status quo}
# data from the committee's document
## 2020 Census
pop_2020 <- "2,749,551"
pop_dist_2020 <- "392,793" # as character with "1,000,000"
dist_largest_2020 <- "2区(476,612人)" #example: "2区(476,612人)"
dist_smallest_2020 <- "5区(276,528人)" #example: "5区(276,528人)"

## 2015 Census
pop_2015 <- "2,809,136" # as character with ""
pop_dist_2015 <- "401,305" # as character with ""
max_to_min_2015 <- 1.612
max_to_tottori2_2015 <- 1.693
dist_largest_2015 <- "2区(480,052人)"
dist_smallest_2015 <- "5区(297,88人)"

## Splits
sq_mun_splits_name <- "江田島市、尾道市、東広島市、三原市" 
sq_gun_splits_name <- ""
sq_koiki_splits_name <- "広島広域都市圏、備後圏域、広島中央地域連携中枢都市圏"

table_about_pref <- dplyr::tribble(
  ~category, ~ r2_basic_info, ~r2_additional_info, ~h27_basic_info, 
  ~h27_additional_info,"人口", pop_2020, "", pop_2015, "",
  
  "議員定数", 
  as.character(ndists_old), 
  paste("変更予定 : ", ndists_new-ndists_old, 
        " (",ndists_old ," → ", ndists_new, ")", sep=""), "", "",
  
  "人口 / 議員定数", 
  pop_dist_2020, "", 
  pop_dist_2015, "",
  
  "県内較差", 
  as.character(sq_max_to_min), 
  paste(dist_largest_2020, " /",
        dist_smallest_2020, sep = ""), 
  as.character(max_to_min_2015), 
  paste(dist_largest_2015, " / ", 
        dist_smallest_2015, sep = ""),
  
  "全国較差", 
  as.character(sq_max_to_tottori2),  "対鳥取2区(274,160人)", 
  as.character(max_to_tottori2_2015), "対鳥取2区(283,502人)",
  
  "市区町村の分割", 
  as.character(sq_mun_splits),  sq_mun_splits_name, "", "",
  
  "郡の分割", 
  as.character(sq_gun_splits), sq_gun_splits_name, "", "",
  
  "広域連携地域の分割", 
  as.character(sq_koiki_splits), sq_koiki_splits_name, "", ""
  ) 

table_about_pref %>% 
  gt(rowname_col = "category") %>% 
  tab_spanner(
    label = "2020年",
    columns = c(r2_basic_info, r2_additional_info)
  ) %>% 
  tab_spanner(
    label = "参考：2015年",
    columns = c(h27_basic_info, h27_additional_info)
  ) %>% 
  tab_row_group(
    label = "1票の格差",
    rows = 4:5
  ) %>% 
  cols_label(
    r2_basic_info = "",
    r2_additional_info = "",
    h27_basic_info = "",
    h27_additional_info = ""
  ) %>% 
  cols_align(
    align = "center",
    columns = c(2,4)
  ) %>% 
  cols_width(
    category ~ pct(20),
    r2_additional_info ~ pct(20),
    h27_additional_info ~ pct(20)
  ) %>%
  tab_source_note(source_note = "出典: 衆議院議員選挙区画定審議会") 
```

# アルゴリズム設定
* 各選挙区の人口を、一票の格差が1となる理論上の選挙区人口の**±0.10**倍以内に設定
* 市区町村を分割しない案、人口が最大の市区町村を分割する案それぞれ25000案を作成
* 飛び地が生じた案を棄却した結果得た区割り案の数は、市区町村を分割しない案に関しては`r length(functioning_results_0$index) `、人口が最大の市区町村を分割する案に関しては`r length(functioning_results_1$index) `

## 県特有の設定
* 飛び地が生じるのを防ぐために、安芸郡と広島市安芸区が異なる選挙区に属するような案は棄却
* 飛び地が生じるのを防ぐために、竹原市及び呉市が東広島市と異なる選挙区に属するような案は棄却

# アルゴリズムが導出した改変案

## 市区町村を分割しない案 : 最適解
一票の格差:`r round(results_0[optimal_0,]$max_to_min, digits = 3) `

```{r optimal plan (0 split), echo = FALSE}
ggplot() +
  geom_sf(data = optimal_boundary_0, aes(fill = factor(district))) +
  scale_fill_manual(values = c("firebrick4", "lightgoldenrod4", "darkorchid4", 
                               "green4", "blue4", "lightcyan3")) +
  geom_sf(data = mun_boundary, fill = NA, color = "grey27", lwd = 0.4) +
  geom_sf(data = gun_boundary, fill = NA, color = "black", lwd = 1.0) +
  labs(caption = "太線:郡の境界") +
  ggthemes::theme_map(base_family = "HiraginoSans-W3") +
  theme(legend.title = element_blank(), legend.position = "None")
```

## 最大市区町村の分割を許容する案 : 最適解
人口が最大の市区町村：福山市

一票の格差：`r round(results_1[optimal_1,]$max_to_min, digits = 3) `

```{r optimal plan (1split), echo = FALSE}
ggplot() +
  geom_sf(data = optimal_boundary_1, aes(fill = factor(district))) +
  scale_fill_manual(values = c("firebrick4", "lightgoldenrod4", "darkorchid4", 
                               "green4", "blue4", "lightcyan3")) +
  geom_sf(data = mun_boundary, fill = NA, color = "grey27", lwd = 0.4) +
  geom_sf(data = gun_boundary, fill = NA, color = "black", lwd = 1.0) +
  labs(caption = "太線:郡の境界") +
  ggthemes::theme_map(base_family = "HiraginoSans-W3") +
  theme(legend.title = element_blank(), legend.position = "None")
```

# 共起分析
* 市区町村分割を許容しない設定で得た区割り改訂案の中で、飛び地がないもののうち、一票の格差が下位10%の案を抽出
* 同じ色の市区町村同士は同じ選挙区に属する傾向が大きい
* 同じ色の市区町村の中でも、濃い色の市区町村の方が、同じ選挙区に属する傾向が大きい

```{r co-occurrence, echo = FALSE}
# Match membership data with map object
pref_0_membership <- cbind(pref_0, cooc_ratio, pref_membership_0)
pref_0_membership_1 <- pref_0_membership %>% dplyr::filter(membership == 1)
pref_0_membership_2 <- pref_0_membership %>% dplyr::filter(membership == 2)
pref_0_membership_3 <- pref_0_membership %>% dplyr::filter(membership == 3)
pref_0_membership_4 <- pref_0_membership %>% dplyr::filter(membership == 4)
pref_0_membership_5 <- pref_0_membership %>% dplyr::filter(membership == 5)
pref_0_membership_6 <- pref_0_membership %>% dplyr::filter(membership == 6)

# Co-occurrence plot
ggplot() +
  geom_sf(data = pref_0_membership_1, aes(fill = cooc_ratio), show.legend = FALSE) +
  scale_fill_gradient(low = "firebrick1", high = "firebrick4") +

  ggnewscale::new_scale_fill() +
  geom_sf(data = pref_0_membership_2, aes(fill = cooc_ratio), show.legend = FALSE) +
  scale_fill_gradient(low = "lightgoldenrod1", high = "lightgoldenrod4") +

  ggnewscale::new_scale_fill() +
  geom_sf(data = pref_0_membership_3, aes(fill = cooc_ratio), show.legend = FALSE) +
  scale_fill_gradient(low = "darkorchid1", high = "darkorchid4") +

  ggnewscale::new_scale_fill() +
  geom_sf(data = pref_0_membership_4, aes(fill = cooc_ratio), show.legend = FALSE) +
  scale_fill_gradient(low = "blue1", high = "blue4") +

  ggnewscale::new_scale_fill() +
  geom_sf(data = pref_0_membership_5, aes(fill = cooc_ratio), show.legend = FALSE) +
  scale_fill_gradient(low = "lightcyan1", high= "lightcyan3") +

  ggnewscale::new_scale_fill() +
  geom_sf(data = pref_0_membership_6, aes(fill = cooc_ratio), show.legend = FALSE) +
  scale_fill_gradient(low="green1", high="green4") +

  geom_sf(data = mun_boundary, fill = NA, color = "grey27", lwd = 0.4) +
  geom_sf(data = gun_boundary, fill = NA, color = "black", lwd = 1.0) +

  labs(caption = "太線:郡の境界") +
  ggthemes::theme_map(base_family = "HiraginoSans-W3") +
  theme(legend.title = element_blank(), legend.position = "None")
```

## まとめ
```{r}
# summary table
table_summary <- dplyr::tribble(
  ~category, ~status_quo, ~split_0, ~split_1,
  "議員定数", ndists_old, ndists_new, ndists_new,
  "県内較差", sq_max_to_min, results_0$max_to_min[optimal_0], results_1$max_to_min[optimal_1],
  "全国較差", sq_max_to_tottori2, max_0/tottori_2, max_1/tottori_2,
  "市区町村の分割", sq_mun_splits, 0, results_1$num_mun_split[optimal_1],
  "郡の分割", sq_gun_splits, results_0$num_gun_split[optimal_0], results_1$num_gun_split[optimal_1],
  "広域連携の分割", sq_koiki_splits, results_0$koiki_split[optimal_0], results_1$koiki_split[optimal_1]
) 

table_summary %>% 
  gt(rowname_col = "category") %>% 
  fmt_number(
    columns = everything(),
    rows = 2:3,
    decimals = 3
  ) %>% 
  tab_row_group(
    label = "1票の格差",
    rows = 2:3
  ) %>% 
  tab_spanner(
    label = "現行の区割り",
    columns = status_quo
  ) %>% 
  tab_spanner(
    label = "アルゴリズムが導出した区割り案",
    columns = c(split_0, split_1)
  ) %>% 
  cols_label(
    status_quo = "",
    split_0 = "市区町村の分割無し",
    split_1 = "最大市区町村の分割を許容"
  ) %>% 
  cols_align(
    align = "center",
    columns = 2:4
  ) 
```
