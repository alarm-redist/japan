---
title: "広島県 (議員定数：7 → 6)"
description: "アルゴリズムによる衆議院小選挙区の区割り改訂案"
date: January 22, 2022 
output: distill::distill_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
options(width = 100)
library(tidyverse)
library(gt)

pref_code <- 34
pref_name <- "hiroshima"
pref_name_kanji <- "広島県"
```

```{r large cities, include = FALSE}
## Find the coordinates of the 県庁, 
## 政令指定都市の市庁舎 (if there is a 政令指定都市 different from 県庁所在地)
## and 中核市の市庁舎 (if there is a 中核市 different from 県庁所在地)
cities <- data.frame(longitude = c(132.45975600, 133.362474, 132.565010), 
                     latitude = c(34.396516, 34.485497, 34.248116))
cities <- sf::st_as_sf(cities, coords = c("longitude", "latitude"), 
                       crs = 4326)

# Adjust coordinates for the labels so that the labels do not overlap with other graphic
cities_labels <- data.frame(longitude = c(132.45975600, 133.362474, 132.565010), 
                            latitude = c(34.45, 34.5, 34.3),
                            names = c("広島市", "福山市", "呉市"))
cities_labels <- sf::st_as_sf(cities_labels, coords = c("longitude", "latitude"), 
                              crs = 4326)
```

```{r load data, include=FALSE}
load(paste("data-out/pref/",
            as.character(pref_code),
            "_",
            as.character(pref_name),
            "_data",
            ".Rdata",
            sep = ""))
```

```{r supplemental for now}
# to be removed once we use updated .r scripts
sq_max_to_min <- 	1.724
sq_max_to_tottori2 <- 1.738
sq_mun_splits <- 4
sq_gun_splits <- 0
sq_koiki_splits <- 3
tottori_2 <- 274160

sq_mun_splits_name <- "江田島市、尾道市、東広島市、三原市" 
sq_gun_splits_name <- ""
sq_koiki_splits_name <- "広島広域都市圏、備後圏域、広島中央地域連携中枢都市圏"
split_1_name <- "福山市"
```


```{r table summary}
# summary table
table_summary <- dplyr::tribble(
  ~category, ~status_quo, ~split_0, ~split_1,
  "県内較差", sq_max_to_min, results_0$max_to_min[optimal_0], results_1$max_to_min[optimal_1],
  "改善率", NA, (sq_max_to_min - results_0$max_to_min[optimal_0])/(sq_max_to_min - 1), (sq_max_to_min - results_1$max_to_min[optimal_1])/(sq_max_to_min - 1),
  "選挙区数", ndists_old, ndists_new, ndists_new,
  "市区町村の分割", sq_mun_splits, 0, results_1$num_mun_split[optimal_1],
  "郡の分割", sq_gun_splits, results_0$num_gun_split[optimal_0], results_1$num_gun_split[optimal_1],
  "広域連携地域の分割", sq_koiki_splits, results_0$koiki_split[optimal_0], results_1$koiki_split[optimal_1]
) 

table_summary %>% 
  gt(rowname_col = "category") %>% 
  fmt_number(
    columns = everything(),
    rows = 1,
    decimals = 3
  ) %>% 
  fmt_percent(
    columns = everything(),
    rows = 2,
    decimals = 1
  ) %>% 
  fmt_missing(
    columns = 2,
    rows = 2,
    missing_text = "-"
  ) %>% 
  tab_row_group(
    label = md("**選挙区の状況**"),
    rows = 3:6
  ) %>%   
  tab_row_group(
    label = md("**1票の格差**"),
    rows = 1:2
  ) %>% 
  tab_spanner(
    label = "現行",
    columns = status_quo
  ) %>% 
  tab_spanner(
    label = "アルゴリズムの提案",
    columns = c(split_0, split_1)
  ) %>% 
  cols_label(
    status_quo = "",
    split_0 = "市区町村の分割無し",
    split_1 = "最大市区町村の分割可"
  ) %>% 
  cols_align(
    align = "center",
    columns = 2:4
  ) %>% 
  cols_width(
    status_quo ~ pct(25),
    split_0 ~ pct(25),
    split_1 ~ pct(25),
  ) %>% 
  tab_header(
    title = md(paste("**", pref_name_kanji, "**", sep = "")),
    subtitle = paste("人口：", format(sum(pref$pop), big.mark = ",", scientific = FALSE), "人（2020年）")
  ) %>% 
  tab_footnote(
    footnote = sq_mun_splits_name,
    locations = cells_body(
      columns = 2,
      rows = 4
    ) 
  ) %>% 
  tab_footnote(
    footnote = split_1_name,
    locations = cells_body(
      columns = 4,
      rows = 4
    ) 
  ) %>% 
 tab_footnote(
    footnote = sq_koiki_splits_name,
    locations = cells_body(
      columns = 2:4,
      rows = 6
    ) 
  ) %>% 
  opt_footnote_marks(marks = "letters") %>% 
  tab_style(
    style = list(
      cell_text(weight = "bold")
      ),
    locations = cells_body(
      columns = 2:4,
      rows = 1
    ) 
  ) 
```


# アルゴリズムの提案
アルゴリズムが提案した25000案のうち、有効な案の中で、一票の格差が最小のもの

### 市区町村を分割しない区割り案
一票の格差 : `r round(results_0[optimal_0,]$max_to_min, digits = 3) `

```{r optimal plan (0 split)}
PAL <- c('#6D9537', '#364B7F', '#DCAD35', '#9A9BB9', '#2A4E45', '#7F4E28')
ggplot() +
  geom_sf(data = optimal_boundary_0, aes(fill = factor(district))) +
  scale_fill_manual(values = PAL) +
  geom_sf(data = mun_boundary, fill = NA, color = "grey27", lwd = 0.4) +
  geom_sf(data = gun_boundary, fill = NA, color = "black", lwd = 1.0) +
  geom_sf(data = cities, size = 2, shape = 21, fill = "red") +
  geom_sf_text(data = cities_labels, aes(label = names), color = "white", 
               size = 3, family = "HiraKakuPro-W3") +
  labs(caption = "太線:郡の境界") +
  ggthemes::theme_map(base_family = "HiraginoSans-W3") +
  theme(legend.title = element_blank(), legend.position = "None") 
```

### 最大市区町村の分割を許容する区割り案 
人口が最大の市区町村 : 福山市

一票の格差 : `r round(results_1[optimal_1,]$max_to_min, digits = 3) `

```{r optimal plan (1split)}
ggplot() +
  geom_sf(data = optimal_boundary_1, aes(fill = factor(district))) +
  scale_fill_manual(values = PAL) +
  geom_sf(data = mun_boundary, fill = NA, color = "grey27", lwd = 0.4) +
  geom_sf(data = gun_boundary, fill = NA, color = "black", lwd = 1.0) +
  geom_sf(data = cities, size = 2, shape = 21, fill = "red") +
  geom_sf_text(data = cities_labels, aes(label = names), color = "white", 
               size = 3, family = "HiraKakuPro-W3") +
  labs(caption = "太線:郡の境界") +
  ggthemes::theme_map(base_family = "HiraginoSans-W3") +
  theme(legend.title = element_blank(), legend.position = "None")
```

# 共起分析
* 市区町村分割のない設定で、飛び地のない有効な案の中のうち、一票の格差が下位10%の案を抽出
* 同色の市区町村は、同じ選挙区に属する傾向が大きい
* 同色の市区町村同士の中でも、濃い色の市区町村の方が、隣接する市区町村と同じ選挙区に属する傾向が大きい

```{r co-occurrence}
# Match membership data with map object
pref_0_membership <- cbind(pref_0, cooc_ratio, pref_membership_0)
pref_0_membership_1 <- pref_0_membership %>% dplyr::filter(membership == 1)
pref_0_membership_2 <- pref_0_membership %>% dplyr::filter(membership == 2)
pref_0_membership_3 <- pref_0_membership %>% dplyr::filter(membership == 3)
pref_0_membership_4 <- pref_0_membership %>% dplyr::filter(membership == 4)
pref_0_membership_5 <- pref_0_membership %>% dplyr::filter(membership == 5)
pref_0_membership_6 <- pref_0_membership %>% dplyr::filter(membership == 6)

# Co-occurrence plot
ggplot() +
  geom_sf(data = pref_0_membership_1, aes(fill = cooc_ratio), show.legend = FALSE) +
 
  scale_fill_gradient(low = '#e3fac3', high = '#6D9537') + #light green

  ggnewscale::new_scale_fill() +
  geom_sf(data = pref_0_membership_2, aes(fill = cooc_ratio), show.legend = FALSE) +
  scale_fill_gradient(low = '#4965ab', high = '#364B7F') + #dark blue

  ggnewscale::new_scale_fill() +
  geom_sf(data = pref_0_membership_3, aes(fill = cooc_ratio), show.legend = FALSE) +
  scale_fill_gradient(low = '#f7de9c', high = '#DCAD35') + #yellow

  ggnewscale::new_scale_fill() +
  geom_sf(data = pref_0_membership_4, aes(fill = cooc_ratio), show.legend = FALSE) +
  scale_fill_gradient(low = '#437d6f', high= '#2A4E45') + #dark green

  ggnewscale::new_scale_fill() +
  geom_sf(data = pref_0_membership_5, aes(fill = cooc_ratio), show.legend = FALSE) +
  scale_fill_gradient(low = '#d99a6a', high = '#7F4E28') + #brown

  ggnewscale::new_scale_fill() +
  geom_sf(data = pref_0_membership_6, aes(fill = cooc_ratio), show.legend = FALSE) +
 scale_fill_gradient(low = '#dfdff2', high = '#9A9BB9') + #light blue

  geom_sf(data = mun_boundary, fill = NA, color = "grey27", lwd = 0.4) +
  geom_sf(data = gun_boundary, fill = NA, color = "black", lwd = 1.0) +
  
  geom_sf(data = cities, size = 2, shape = 21, fill = "red") +
  geom_sf_text(data = cities_labels, aes(label = names), color = "white", 
               size = 3, family = "HiraKakuPro-W3") +

  labs(caption = "太線:郡の境界") +
  ggthemes::theme_map(base_family = "HiraginoSans-W3") +
  theme(legend.title = element_blank(), legend.position = "None")
```

# アルゴリズム設定

* 各選挙区の人口 : (県内の総人口 / 選挙区数) ±10%
* アルゴリズムが導出する案の総数 : `r format(nsims, big.mark = ",")`
* 有効な区割り案（飛び地を生じさせない）の数 : 
    + 市区町村の分割無し : `r format(length(functioning_results_0$index), big.mark = ",", scientific = FALSE)`  
    + 人口最大の市区町村の分割を許容 : `r format(length(functioning_results_1$index), big.mark = ",",  scientific = FALSE)`  
* 有効な案から一票の格差が最小の区割り案を選定

### 県特有の設定  
飛び地を防ぐため、以下の案は棄却: 

* 安芸郡と広島市安芸区が異なる選挙区に属する案  
* 竹原市及び呉市が、東広島市と異なる選挙区に属する案  

