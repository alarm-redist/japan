---
title: "34_smc_hiroshima"
output: html_document
  toc: true
  toc_float: true 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '/Users/kentoyamada/Desktop/ALARM Project/jcdf')
```

# I. Simulations
## 1. Set Up and Data Cleaning Process
### 1.1 Set Up
```{r eval=FALSE}
library(tidyverse)
set.seed(12345)

# pull functions from jcdf
# set working directory to the function folder
setwd("R")
files.sources = list.files()
sapply(files.sources, source)
# set working directory back to `jcdf`
setwd("..")
```

#### Define Prefectural Data 
```{r}
sim_type <- "smc"
nsims <- 25000
pref_code <- 34
pref_name <- "hiroshima"
lakes_removed <- c() 
ndists_new <- 6
ndists_old <- 7
n_split <- 4
```

### 1.2.Download and Clean Census Data
```{r warning=FALSE, message=FALSE}
# download census shapefile
pref_raw <- download_shp(pref_code)
dem_pops <- download_pop_demographics(pref_code)

# download 2020 census data
total <- download_2020_census(type = "total")
foreigner <- download_2020_census(type = "foreigner")
#Clean 2020 census
census2020 <- clean_2020_census(total = total, foreigner = foreigner)

# download historical boundary data
old_boundary <- download_old_shp(pref_code = pref_code)

# populations based on historical boundaries
pop_by_old_boundary <- download_2015pop_old(pref_code = pref_code)
```

### 1.3 Use `clean_jcdf()` function to clean census data
```{r warning=FALSE, message=FALSE}
pref <- pref_raw %>%
  clean_jcdf() %>%
  dplyr::group_by(code, CITY_NAME) %>%
  dplyr::summarise(geometry = sf::st_union(geometry)) %>%
  dplyr::left_join(census2020, by = c('code')) %>%
  dplyr::rename(pop = pop_national) %>%
  dplyr::select(code, pop, geometry)
```

### 1.4 Use `merge_gun()` to make a new column for codes of guns
`merge_gun()` assigns each gun a unique code.
```{r}
pref <- merge_gun(pref)
```

### 1.5 Define "Koiki-renkei" Areas
```{r}
#assign which municipality belongs to which koiki renkei area
hiroshima_koiki <- c(34101, 34102, 34103, 34104, 34105, 34106, 34107, 34108,
                     34202, 34203, 34204, 34211, 34212, 34213, 34214, 34215,
                     34302, 34304, 34307, 34309, 34368, 34369, 34431, 34462)
bingo_koiki <- c(34207, 34204, 34205, 34208, 34462, 34545)
hiroshima_chuo_koiki <- c(34202, 34203, 34212, 34215, 34304, 34307, 34309, 34431)
```

## 2. Run Simulations with 0 Municipality Splits (without taking into accoun "Koiki-renkei")
### 2.1 Finalize pref object
We merge together the gun and treat them as one geographical unit. In Hiroshima Prefecture, all the gun are kept together in the same district, so we will merge together all the gun.
```{r}
pref_0 <- sf::st_as_sf(
  pref %>%
    dplyr::group_by(gun_code) %>%
    dplyr::summarize(geometry = sf::st_union(geometry),
                     pop = sum(pop),
                     code = code[1])
)
```

### 2.2 Make adjacency graph
```{r}
prefadj_0 <- redist::redist.adjacency(pref_0)
```

### 2.3 Add edges to adjacency graph
```{r}
if(check_ferries(pref_code) == TRUE){
  # add ferries
  ferries_0 <- add_ferries(pref_0)
  prefadj_0 <- geomander::add_edge(prefadj_0,
                                  ferries_0[, 1],
                                  ferries_0[, 2],
                                  zero = TRUE)
}
```

### 2.4 Define redist.map object
```{r}
pref_map_0 <- redist::redist_map(pref_0,
                                 ndists = ndists_new,
                                 pop_tol= 0.10,
                                 total_pop = pop,
                                 adj = prefadj_0)
```

###2.5 Run Simulation
```{r}
sim_smc_pref_0 <- redist::redist_smc(pref_map_0,
                                     nsims = nsims,
                                     pop_temper = 0.05)
```

### 2.6 Save results of simulation
```{r}
saveRDS(sim_smc_pref_0, paste("simulation/",
                              as.character(pref_code),
                              "_",
                              as.character(pref_name),
                              "_",
                              as.character(sim_type),
                              "_",
                              as.character(nsims),
                              "_0",
                              ".Rds",
                              sep = ""))
```

## 3. Run Simulations with 1 Municipality Split
### 3.1 Split the largest municipality based on its old municipality boundaries
```{r}
split_codes <- (pref %>% dplyr::filter(code >= (pref$code[1]%/%1000)*1000+200))[order(-(pref %>% dplyr::filter(code >= (pref$code[1]%/%1000)*1000+200))$pop), ]$code[1:n_split]
new_1 <- as.character(split_codes[1])
old_1 <- find_old_codes(new_1, pop_by_old_boundary)
pref_1 <- reflect_old_boundaries(pref, old_boundary, pop_by_old_boundary, old_1, new_1)
pref_1 <- estimate_old_boundary_pop(old_1, new_1, pref_1, census2020)
```

### 3.2 Finalize pref object
We merge together the gun and treat them as one geographical unit, except for the guns that are split under the status quo. We merge together the gun and treat them as one geographical unit. In Hiroshima Prefecture, all the gun are kept together in the same district, so we will merge together all the gun.
```{r}
pref_1 <- sf::st_as_sf(
  pref_1 %>%
    dplyr::group_by(gun_code) %>%
    dplyr::summarize(geometry = sf::st_union(geometry),
                    pop = sum(pop),
                   code = code[1],
                   pre_gappei_code = pre_gappei_code[1])
)
```

### 3.3 Make adjacency graph
```{r}
prefadj_1 <- redist::redist.adjacency(pref_1)
```

### 3.4 Add edges to adjacency graph
```{r}
if(check_ferries(pref_code) == TRUE){
  # add ferries
  ferries_1 <- add_ferries(pref_1)
  prefadj_1 <- geomander::add_edge(prefadj_1,
                                 ferries_1[, 1],
                                 ferries_1[, 2],
                                 zero = TRUE)
}
```

###For Hiroshima Only: 
As a result of splitting Fukuyama-shi, Utsumi-cho, Fukuyama-shi appears to be disconnected from the mainland. To fix this, we must add an adjacency edge between Utsumi-cho(34481) and Numakuma-cho(34482)
```{r}
prefadj_1 <- geomander::add_edge(prefadj_1, 
                                 which(pref_1$pre_gappei_code == 34481), 
                                 which(pref_1$pre_gappei_code == 34482))
```

### 3.5 Define redist.map object
```{r}
pref_map_1 <- redist::redist_map(pref_1,
                                 ndists = ndists_new,
                                 pop_tol= 0.10,
                                 total_pop = pop,
                                 adj = prefadj_1)
```

### 3.6 Run Simulation
```{r}
sim_smc_pref_1 <- redist::redist_smc(pref_map_1,
                                     nsims = nsims,
                                     pop_temper = 0.05)
```

### 3.7 Save results of simulation
```{r}
saveRDS(sim_smc_pref_1, paste("simulation/",
                              as.character(pref_code),
                              "_",
                              as.character(pref_name),
                              "_",
                              as.character(sim_type),
                              "_",
                              as.character(nsims),
                              "_1",
                              ".Rds",
                              sep = ""))
```

## 4. Run Simulations with 2 Municipality Split
### 4.1 Split the largest municipality based on its old municipality boundaries
```{r}
new_2 <- as.character(split_codes[2])
old_2 <- find_old_codes(new_2, pop_by_old_boundary)
pref_2 <- reflect_old_boundaries(pref_1, old_boundary, pop_by_old_boundary, old_2, new_2)
pref_2 <- estimate_old_boundary_pop(old_2, new_2, pref_2, census2020)
```

### 4.2 Finalize pref object
No additional steps are needed here; the guns have already been merged.

### 4.3 Make adjacency graph
```{r}
prefadj_2 <- redist::redist.adjacency(pref_2)
```

### 4.4 Add edges to adjacency graph
```{r}
if(check_ferries(pref_code) == TRUE){
  # add ferries
  ferries_2 <- add_ferries(pref_2)
  prefadj_2 <- geomander::add_edge(prefadj_2,
                                  ferries_2[, 1],
                                  ferries_2[, 2],
                                  zero = TRUE)
}
```

###For Hiroshima Only: 
As a result of splitting Fukuyama-shi, Utsumi-cho, Fukuyama-shi appears to be disconnected from the mainland. To fix this, we must add an adjacency edge between Utsumi-cho(34481) and Numakuma-cho(34482).
Similarly, as a result of splitting Kure-shi, Shimokamagari-cho and Kamagari-cho appear to be disconnected from the mainland. To fix this, we must add an adjacency edge between Shimokamagari-cho (34313) and Kure-shi (34202) as well as between Kamagari-cho (34314) and Shimokamagari-cho (34313).
In addition, Otodo-cho appear to be disconnected from the mainland. Thus, we add an adjacency edge between Otodo-cho (34311) and Kure-shi (34202) as well as between Otodo-cho (34311) and Etajima-shi (34215)


```{r}
prefadj_2 <- geomander::add_edge(prefadj_2, 
                                 which(pref_2$pre_gappei_code == 34481), 
                                 which(pref_2$pre_gappei_code == 34482))
prefadj_2 <- geomander::add_edge(prefadj_2, 
                                 which(pref_2$pre_gappei_code == 34313), 
                                 which(pref_2$pre_gappei_code == 34202))
prefadj_2 <- geomander::add_edge(prefadj_2, 
                                 which(pref_2$pre_gappei_code == 34313), 
                                 which(pref_2$pre_gappei_code == 34314))
prefadj_2 <- geomander::add_edge(prefadj_2, 
                                 which(pref_2$pre_gappei_code == 34311), 
                                 which(pref_2$pre_gappei_code == 34202))
prefadj_2 <- geomander::add_edge(prefadj_2, 
                                 which(pref_2$pre_gappei_code == 34311), 
                                 which(pref_2$pre_gappei_code == 34215))
```

### 4.5 Define redist.map object
```{r}
pref_map_2 <- redist::redist_map(pref_2,
                                 ndists = ndists_new,
                                 pop_tol= 0.10,
                                 total_pop = pop,
                                 adj = prefadj_2)
```

### 4.6 Run Simulation
```{r}
sim_smc_pref_2 <- redist::redist_smc(pref_map_2,
                                     nsims = nsims,
                                     pop_temper = 0.05)
```

### 4.7 Save results of simulation
```{r}
saveRDS(sim_smc_pref_2, paste("simulation/",
                              as.character(pref_code),
                              "_",
                              as.character(pref_name),
                              "_",
                              as.character(sim_type),
                              "_",
                              as.character(nsims),
                              "_2",
                              ".Rds",
                              sep = ""))
```

## 5. Run Simulations with 3 Municipality Split
### 5.1 Split the largest municipality based on its old municipality boundaries
```{r}
new_3 <- as.character(split_codes[3])
old_3 <- find_old_codes(new_3, pop_by_old_boundary)
pref_3 <- reflect_old_boundaries(pref_2, old_boundary, pop_by_old_boundary, old_3, new_3)
pref_3 <- estimate_old_boundary_pop(old_3, new_3, pref_3, census2020)
```

### 5.2 Finalize pref object
No additional steps are needed here; the guns have already been merged.

### 5.3 Make adjacency graph
```{r}
prefadj_3 <- redist::redist.adjacency(pref_3)
```

### 4.4 Add edges to adjacency graph
```{r}
if(check_ferries(pref_code) == TRUE){
  # add ferries
   ferries_3 <- add_ferries(pref_3)
   prefadj_3 <- geomander::add_edge(prefadj_3,
                                  ferries_3[, 1],
                                  ferries_3[, 2],
                                  zero = TRUE)
}
```

###For Hiroshima Only: 
As a result of splitting Fukuyama-shi, Utsumi-cho, Fukuyama-shi appears to be disconnected from the mainland. To fix this, we must add an adjacency edge between Utsumi-cho(34481) and Numakuma-cho(34482).
Similarly, as a result of splitting Kure-shi, Shimokamagari-cho and Kamagari-cho appear to be disconnected from the mainland. To fix this, we must add an adjacency edge between Shimokamagari-cho (34313) and Kure-shi (34202) as well as between Kamagari-cho (34314) and Shimokamagari-cho (34313).
In addition, Otodo-cho appears to be disconnected from the mainland. Thus, we add an adjacency edge between Otodo-cho (34311) and Kure-shi (34202) as well as between Otodo-cho (34311) and Etajima-shi (34215)


```{r}
prefadj_3 <- geomander::add_edge(prefadj_3, 
                                 which(pref_3$pre_gappei_code == 34481), 
                                 which(pref_3$pre_gappei_code == 34482))
prefadj_3 <- geomander::add_edge(prefadj_3, 
                                 which(pref_3$pre_gappei_code == 34313), 
                                 which(pref_3$pre_gappei_code == 34202))
prefadj_3 <- geomander::add_edge(prefadj_3, 
                                 which(pref_3$pre_gappei_code == 34313), 
                                 which(pref_3$pre_gappei_code == 34314))
prefadj_3 <- geomander::add_edge(prefadj_3, 
                                 which(pref_3$pre_gappei_code == 34311), 
                                 which(pref_3$pre_gappei_code == 34202))
prefadj_3 <- geomander::add_edge(prefadj_3, 
                                 which(pref_3$pre_gappei_code == 34311), 
                                 which(pref_3$pre_gappei_code == 34215))
```

### 5.5 Define redist.map object
```{r}
pref_map_3 <- redist::redist_map(pref_3,
                                 ndists = ndists_new,
                                 pop_tol= 0.10,
                                 total_pop = pop,
                                 adj = prefadj_3)
```

### 5.6 Run Simulation
```{r}
sim_smc_pref_3 <- redist::redist_smc(pref_map_3,
                                     nsims = nsims,
                                     pop_temper = 0.05)
```

### 5.7 Save results of simulation
```{r}
saveRDS(sim_smc_pref_3, paste("simulation/",
                              as.character(pref_code),
                              "_",
                              as.character(pref_name),
                              "_",
                              as.character(sim_type),
                              "_",
                              as.character(nsims),
                              "_3",
                              ".Rds",
                              sep = ""))
```

## 6. Run Simulations with 4 Municipality Split
### 6.1 Split the largest municipality based on its old municipality boundaries
```{r}
new_4 <- as.character(split_codes[4])
old_4 <- find_old_codes(new_4, pop_by_old_boundary)
pref_4 <- reflect_old_boundaries(pref_3, old_boundary, pop_by_old_boundary, old_4, new_4)
pref_4 <- estimate_old_boundary_pop(old_4, new_4, pref_4, census2020)
```

### 6.2 Finalize pref object
No additional steps are needed here; the guns have already been merged.

### 6.3 Make adjacency graph
```{r}
prefadj_4 <- redist::redist.adjacency(pref_4)
```

### 4.4 Add edges to adjacency graph
```{r}
if(check_ferries(pref_code) == TRUE){
  # add ferries
   ferries_4 <- add_ferries(pref_4)
   prefadj_4 <- geomander::add_edge(prefadj_4,
                                  ferries_4[, 1],
                                  ferries_4[, 2],
                                  zero = TRUE)
}
```

###For Hiroshima Only: 
As a result of splitting Fukuyama-shi, Utsumi-cho, Fukuyama-shi appears to be disconnected from the mainland. To fix this, we must add an adjacency edge between Utsumi-cho(34481) and Numakuma-cho(34482).
Similarly, as a result of splitting Kure-shi, Shimokamagari-cho and Kamagari-cho appear to be disconnected from the mainland. To fix this, we must add an adjacency edge between Shimokamagari-cho (34313) and Kure-shi (34202) as well as between Kamagari-cho (34314) and Shimokamagari-cho (34313).
In addition, Otodo-cho appears to be disconnected from the mainland. Thus, we add an adjacency edge between Otodo-cho (34311) and  Kure-shi (34202) as well as between Otodo-cho (34311) and Etajima-shi (34215)
Also, Innoshima appears to be disconnected from the mainland. Thus, we add an adjacency edge between Innoshima (34206) and Mukaishima (34444).

```{r}
prefadj_4 <- geomander::add_edge(prefadj_4, 
                                 which(pref_4$pre_gappei_code == 34481), 
                                 which(pref_4$pre_gappei_code == 34482))
prefadj_4 <- geomander::add_edge(prefadj_4, 
                                 which(pref_4$pre_gappei_code == 34313), 
                                 which(pref_4$pre_gappei_code == 34202))
prefadj_4 <- geomander::add_edge(prefadj_4, 
                                 which(pref_4$pre_gappei_code == 34313), 
                                 which(pref_4$pre_gappei_code == 34314))
prefadj_4 <- geomander::add_edge(prefadj_4, 
                                 which(pref_4$pre_gappei_code == 34311), 
                                 which(pref_4$pre_gappei_code == 34202))
prefadj_4 <- geomander::add_edge(prefadj_4, 
                                 which(pref_4$pre_gappei_code == 34311), 
                                 which(pref_4$pre_gappei_code == 34215))
prefadj_4 <- geomander::add_edge(prefadj_4, 
                                 which(pref_4$pre_gappei_code == 34206), 
                                 which(pref_4$pre_gappei_code == 34444))
```

### 4.5 Define redist.map object
```{r}
pref_map_4 <- redist::redist_map(pref_4,
                                 ndists = ndists_new,
                                 pop_tol= 0.10,
                                 total_pop = pop,
                                 adj = prefadj_4)
```

### 4.6 Run Simulation
```{r}
sim_smc_pref_4 <- redist::redist_smc(pref_map_4,
                                     nsims = nsims,
                                     pop_temper = 0.05)
```

### 4.7 Save results of simulation
```{r}
saveRDS(sim_smc_pref_4, paste("simulation/",
                              as.character(pref_code),
                              "_",
                              as.character(pref_name),
                              "_",
                              as.character(sim_type),
                              "_",
                              as.character(nsims),
                              "_4",
                              ".Rds",
                              sep = ""))
```

# II. Analysis
## 1. Get Optimal Plan
### 1.1 Extract Plans
```{r}
pref_smc_plans_0 <- redist::get_plans_matrix(sim_smc_pref_0)
pref_smc_plans_1 <- redist::get_plans_matrix(sim_smc_pref_1)
pref_smc_plans_2 <- redist::get_plans_matrix(sim_smc_pref_2)
pref_smc_plans_3 <- redist::get_plans_matrix(sim_smc_pref_3)
pref_smc_plans_4 <- redist::get_plans_matrix(sim_smc_pref_4)
```

### 1.2 Calculate Max:min ratio
```{r}
wgt_smc_0 <- simulation_weight_disparity_table(sim_smc_pref_0)
wgt_smc_1 <- simulation_weight_disparity_table(sim_smc_pref_1)
wgt_smc_2 <- simulation_weight_disparity_table(sim_smc_pref_2)
wgt_smc_3 <- simulation_weight_disparity_table(sim_smc_pref_3)
wgt_smc_4 <- simulation_weight_disparity_table(sim_smc_pref_4)
```

### 1.3 Count municipality/gun/koiki renkei splits
Whereas `count_splits()` counts the total number of splits, `redist.splits()` counts the number of geographical units that are split.
```{r}
#assign koiki_renkei area codes
#assign which municipality/gun belongs to which koiki renkei area
#make sure to convert municipality codes into to "gun" codes
koiki_1_codes <-  c(34101, 34102, 34103, 34104, 34105, 34106, 34107, 34108,
                    34202, 34203, 34204, 34211, 34212, 34213, 34214, 34215,
                    34300, 34360, 34420, 34460)
koiki_2_codes <- c(34207, 34204, 34205, 34208, 34460, 34540)
koiki_3_codes <- c(34202, 34203, 34212, 34215, 34300, 34420)


#assign koiki_renkei area codes for simulation with 0 split
koiki_1_0 <- pref_0$gun_code
koiki_1_0[koiki_1_0 %in% koiki_1_codes] <- 1
koiki_2_0 <- pref_0$gun_code
koiki_2_0[koiki_2_0 %in% koiki_2_codes] <- 2
koiki_3_0 <- pref_0$gun_code
koiki_3_0[koiki_3_0 %in% koiki_3_codes] <- 3

#assign koiki_renkei area codes for simulation with 1 split
koiki_1_1 <- pref_1$gun_code
koiki_1_1[koiki_1_1 %in% koiki_1_codes] <- 1
koiki_2_1 <- pref_1$gun_code
koiki_2_1[koiki_2_1 %in% c(koiki_2_codes, setdiff(old_1, 34207))] <- 2
#Fukuyama-shi(34207) is now broken up into 5 units
koiki_3_1 <- pref_1$gun_code
koiki_3_1[koiki_3_1 %in% koiki_3_codes] <- 3


#assign koiki_renkei area codes for simulation with 2 splits
koiki_1_2 <- pref_2$gun_code
koiki_1_2[koiki_1_2 %in% c(koiki_1_codes, setdiff(old_2, 34202))] <- 1
#Kure-shi(34202) is now broken up into 9 units
koiki_2_2 <- pref_2$gun_code
koiki_2_2[koiki_2_2 %in% c(koiki_2_codes, setdiff(old_1, 34207))] <- 2
#Fukuyama-shi(34207) is now broken up into 5 units
koiki_3_2 <- pref_2$gun_code
koiki_3_2[koiki_3_2 %in% c(koiki_3_codes, setdiff(old_2, 34202))] <- 3


#assign koiki_renkei area codes for simulation with 3 splits
koiki_1_3 <- pref_3$gun_code
koiki_1_3[koiki_1_3 %in% c(koiki_1_codes, setdiff(old_2, 34202), setdiff(old_3, 34212))] <- 1
#Kure-shi(34202) and Higashi-hiroshima-shi are now split
koiki_2_3 <- pref_3$gun_code
koiki_2_3[koiki_2_3 %in% c(koiki_2_codes, setdiff(old_1, 34207))] <- 2
#Fukuyama-shi(34207) is now broken up into 5 units
koiki_3_3 <- pref_3$gun_code
koiki_3_3[koiki_3_3 %in% c(koiki_3_codes, setdiff(old_2, 34202), setdiff(old_3, 34212))] <- 3
#Kure-shi(34202) and Higashi-hiroshima-shi are now split

#assign koiki_renkei area codes for simulation with 4 splits
koiki_1_4 <- pref_4$gun_code
koiki_1_4[koiki_1_4 %in% c(koiki_1_codes, setdiff(old_2, 34202), setdiff(old_3, 34212))] <- 1
#Kure-shi(34202) and Higashi-hiroshima-shi are now split
koiki_2_4 <- pref_4$gun_code
koiki_2_4[koiki_2_4 %in% c(koiki_2_codes, setdiff(old_1, 34207), setdiff(old_4, 34205))] <- 2
#Fukuyama-shi(34207) and Onomichi-shi (34205) are now broken up into 5 units
koiki_3_4 <- pref_4$gun_code
koiki_3_4[koiki_3_4 %in% c(koiki_3_codes, setdiff(old_2, 34202), setdiff(old_3, 34212))] <- 3
#Kure-shi(34202) and Higashi-hiroshima-shi are now split
```

```{r}
num_gun_split_0 <- count_splits(pref_smc_plans_0, pref_map_0$gun_code)
gun_split_0 <- redist::redist.splits(pref_smc_plans_0, pref_map_0$gun_code)

koiki_split_0 <- 
  redist::redist.splits(pref_smc_plans_0, koiki_1_0) + 
  redist::redist.splits(pref_smc_plans_0, koiki_2_0) +
  redist::redist.splits(pref_smc_plans_0, koiki_3_0)
```

```{r}
num_mun_split_1 <- count_splits(pref_smc_plans_1, pref_map_1$code)
mun_split_1 <- redist::redist.splits(pref_smc_plans_1, pref_map_1$code)

num_gun_split_1 <- count_splits(pref_smc_plans_1, pref_map_1$gun_code)
gun_split_1 <- redist::redist.splits(pref_smc_plans_1, pref_map_1$gun_code)

koiki_split_1 <- 
  redist::redist.splits(pref_smc_plans_1, koiki_1_1) + 
  redist::redist.splits(pref_smc_plans_1, koiki_2_1) +
  redist::redist.splits(pref_smc_plans_1, koiki_3_1)
```

```{r}
num_mun_split_2 <- count_splits(pref_smc_plans_2, pref_map_2$code)
mun_split_2 <- redist::redist.splits(pref_smc_plans_2, pref_map_2$code)

num_gun_split_2 <- count_splits(pref_smc_plans_2, pref_map_2$gun_code)
gun_split_2 <- redist::redist.splits(pref_smc_plans_2, pref_map_2$gun_code)

koiki_split_2 <- 
  redist::redist.splits(pref_smc_plans_2, koiki_1_2) + 
  redist::redist.splits(pref_smc_plans_2, koiki_2_2) +
  redist::redist.splits(pref_smc_plans_2, koiki_3_2)
```

```{r}
num_mun_split_3 <- count_splits(pref_smc_plans_3, pref_map_3$code)
mun_split_3 <- redist::redist.splits(pref_smc_plans_3, pref_map_3$code)

num_gun_split_3 <- count_splits(pref_smc_plans_3, pref_map_3$gun_code)
gun_split_3 <- redist::redist.splits(pref_smc_plans_3, pref_map_3$gun_code)

koiki_split_3 <- 
  redist::redist.splits(pref_smc_plans_3, koiki_1_3) + 
  redist::redist.splits(pref_smc_plans_3, koiki_2_3) +
  redist::redist.splits(pref_smc_plans_3, koiki_3_3)
```

```{r}
num_mun_split_4 <- count_splits(pref_smc_plans_4, pref_map_4$code)
mun_split_4 <- redist::redist.splits(pref_smc_plans_4, pref_map_4$code)

num_gun_split_4 <- count_splits(pref_smc_plans_4, pref_map_4$gun_code)
gun_split_4 <- redist::redist.splits(pref_smc_plans_4, pref_map_4$gun_code)

koiki_split_4 <- 
  redist::redist.splits(pref_smc_plans_4, koiki_1_4) + 
  redist::redist.splits(pref_smc_plans_4, koiki_2_4) +
  redist::redist.splits(pref_smc_plans_4, koiki_3_4)
```

### 1.4 Compile Results
The table created includes information on the max:min ratio as well as the number of municipality/gun/koiki-renkei splits. We also check whether there are cases where a municipality is split into more than 2 districts, in which case such results are filtered out.

```{r}
results_0 <- data.frame(matrix(ncol = 0, nrow = nrow(wgt_smc_0)))
results_0$max_to_min <- wgt_smc_0$max_to_min

#number of gun splits
results_0$num_gun_split <- num_gun_split_0
results_0$gun_split <- gun_split_0

#number of koiki renkei area splits
results_0$koiki_split <- koiki_split_0

results_0$index <- 1:nrow(wgt_smc_0)
```

```{r}
# Post-processing: filter out plans with discontiguous districts

#in this case, Aki-ku(Hiroshima-shi; code: 34107) and Aki-gun (code: 34300) must be in the same district to avoid creating discontiguous districts
contiguous_0 <- 1:25000
for(i in 1:25000){
   contiguous_0[i] <- 
     as.integer(pref_smc_plans_0[,i][which(pref_0$gun_code == 34107)] == pref_smc_plans_0[,i][which(pref_0$gun_code == 34300)])
}
results_0$contiguous <- contiguous_0

#Ferry routes connect Takehara-shi (34203), Higashihiroshima-shi (34212), and Kure-shi (34202) to Osakikamijima-cho.
#However, Takehara-shi and Kure-shi are not connected by land.
#Thus, we must make sure to avoid a situation in which Takehara-shi and Takehara-shi both belong to the district that is different from the district Higashihiroshima-shi belongs to.
ferry_discontiguity_0 <- 1:25000
for(i in 1:25000){
   ferry_discontiguity_0[i] <- 
     as.integer(
      #We must avoid a situation in which Kure-shi (34202) and Takehara-shi(34203) belong to the same district
      pref_smc_plans_0[,i][which(pref_0$gun_code == 34202)] == pref_smc_plans_0[,i][which(pref_0$gun_code == 34203)]&
      #whereby that district is different from the district Higashihiroshima-shi (34212) belongs to
      pref_smc_plans_0[,i][which(pref_0$gun_code == 34202)] != pref_smc_plans_0[,i][which(pref_0$gun_code == 34212)]
      )
}
results_0$ferry_discontiguity <- ferry_discontiguity_0
```

```{r}
results_1 <- data.frame(matrix(ncol = 0, nrow = nrow(wgt_smc_1)))
results_1$max_to_min <- wgt_smc_1$max_to_min

#number of municipality splits
results_1$nun_mun_split <- num_mun_split_1
results_1$mun_split <- mun_split_1

#check whether there are cases where a municipality is split into more than 2 districts
results_1$multi <-  results_1$nun_mun_split - results_1$mun_split

#number of gun splits
results_1$num_gun_split <- num_gun_split_1
results_1$gun_split <- gun_split_1

#number of koiki renkei area splits
results_1$koiki_split <- koiki_split_1

results_1$index <- 1:nrow(wgt_smc_1)
```

```{r}
# Post-processing: filter out plans with discontiguous districts

#in this case, Aki-ku(Hiroshima-shi; code: 34107) and Aki-gun (code: 34300) must be in the same district to avoid creating discontiguous districts
contiguous_1 <- 1:25000
for(i in 1:25000){
   contiguous_1[i] <- 
     as.integer(pref_smc_plans_1[,i][which(pref_1$gun_code == 34107)] == pref_smc_plans_1[,i][which(pref_1$gun_code == 34300)])
}
results_1$contiguous <- contiguous_1

#Ferry routes connect Takehara-shi (34203), Higashihiroshima-shi (34212), and Kure-shi (34202) to Osakikamijima-cho.
#However, Takehara-shi and Kure-shi are not connected by land.
#Thus, we must make sure to avoid a situation in which Takehara-shi and Takehara-shi both belong to the district that is different from the district Higashihiroshima-shi belongs to.
ferry_discontiguity_1 <- 1:25000
for(i in 1:25000){
   ferry_discontiguity_1[i] <- 
     as.integer(
      #We must avoid a situation in which Kure-shi (34202) and Takehara-shi(34203) belong to the same district
      pref_smc_plans_1[,i][which(pref_1$gun_code == 34202)] == pref_smc_plans_1[,i][which(pref_1$gun_code == 34203)]&
      #whereby that district is different from the district Higashihiroshima-shi (34212) belongs to
      pref_smc_plans_1[,i][which(pref_1$gun_code == 34202)] != pref_smc_plans_1[,i][which(pref_1$gun_code == 34212)]
      )
}
results_1$ferry_discontiguity <- ferry_discontiguity_1
```

```{r}
results_2 <- data.frame(matrix(ncol = 0, nrow = nrow(wgt_smc_2)))
results_2$max_to_min <- wgt_smc_2$max_to_min

#number of municipality splits
results_2$nun_mun_split <- num_mun_split_2
results_2$mun_split <- mun_split_2

#check whether there are cases where a municipality is split into more than 2 districts
results_2$multi <-  results_2$nun_mun_split - results_2$mun_split

#number of gun splits
results_2$num_gun_split <- num_gun_split_2
results_2$gun_split <- gun_split_2

#number of koiki renkei area splits
results_2$koiki_split <- koiki_split_2

results_2$index <- 1:nrow(wgt_smc_2)
```

```{r}
# Post-processing: filter out plans with discontiguous districts

#in this case, Aki-ku(Hiroshima-shi; code: 34107) and Aki-gun (code: 34300) must be in the same district to avoid creating discontiguous districts
contiguous_2 <- 1:25000
for(i in 1:25000){
   contiguous_2[i] <- 
     as.integer(pref_smc_plans_2[,i][which(pref_2$gun_code == 34107)] == pref_smc_plans_2[,i][which(pref_2$gun_code == 34300)])
}
results_2$contiguous <- contiguous_2

#Ferry routes connect Kure-shi (34202) to Minami-ku, Hiroshima-shi (34103).
#However, Kure-shi and Minami-ku, Hiroshima-shi are  not connected by land.
#Thus, we must make sure to avoid a situation in which Kure-shi and Minami-ku, Hiroshima-shi both belong to the district that is different from the district Aki-gun(34300) belongs to.
ferry_discontiguity_2 <- 1:25000
for(i in 1:25000){
   ferry_discontiguity_2[i] <- 
     as.integer(
      #We must avoid a situation in which Kure-shi (34202) and Minami-ku, Hiroshima-shi (34103) belong to the same district
      pref_smc_plans_2[,i][which(pref_2$gun_code == 34202)] == pref_smc_plans_2[,i][which(pref_2$gun_code == 34103)]&
      #whereby that district is different from the district Aki-gun (34300) belongs to
      pref_smc_plans_2[,i][which(pref_2$gun_code == 34202)] != pref_smc_plans_2[,i][which(pref_2$gun_code == 34300)]
      )
}
results_2$ferry_discontiguity <- ferry_discontiguity_2
```

```{r}
results_3 <- data.frame(matrix(ncol = 0, nrow = nrow(wgt_smc_3)))
results_3$max_to_min <- wgt_smc_3$max_to_min

#number of municipality splits
results_3$nun_mun_split <- num_mun_split_3
results_3$mun_split <- mun_split_3

#check whether there are cases where a municipality is split into more than 2 districts
results_3$multi <-  results_3$nun_mun_split - results_3$mun_split

#number of gun splits
results_3$num_gun_split <- num_gun_split_3
results_3$gun_split <- gun_split_3

#number of koiki renkei area splits
results_3$koiki_split <- koiki_split_3

results_3$index <- 1:nrow(wgt_smc_3)
```
```{r}
# Post-processing: filter out plans with discontiguous districts

#in this case, Aki-ku(Hiroshima-shi; code: 34107) and Aki-gun (code: 34300) must be in the same district to avoid creating discontiguous districts
contiguous_3 <- 1:25000
for(i in 1:25000){
   contiguous_3[i] <- 
     as.integer(pref_smc_plans_3[,i][which(pref_3$gun_code == 34107)] == pref_smc_plans_3[,i][which(pref_3$gun_code == 34300)])
}
results_3$contiguous <- contiguous_3

#Ferry routes connect Kure-shi (34202) to Minami-ku, Hiroshima-shi (34103).
#However, Kure-shi and Minami-ku, Hiroshima-shi are  not connected by land.
#Thus, we must make sure to avoid a situation in which Kure-shi and Minami-ku, Hiroshima-shi both belong to the district that is different from the district Aki-gun(34300) belongs to.
ferry_discontiguity_3 <- 1:25000
for(i in 1:25000){
   ferry_discontiguity_3[i] <- 
     as.integer(
      #We must avoid a situation in which Kure-shi (34202) and Minami-ku, Hiroshima-shi (34103) belong to the same district
      pref_smc_plans_3[,i][which(pref_3$gun_code == 34202)] == pref_smc_plans_3[,i][which(pref_3$gun_code == 34103)]&
      #whereby that district is different from the district Aki-gun (34300) belongs to
      pref_smc_plans_3[,i][which(pref_3$gun_code == 34202)] != pref_smc_plans_3[,i][which(pref_3$gun_code == 34300)]
      )
}
results_3$ferry_discontiguity <- ferry_discontiguity_3
```
```{r}
results_4 <- data.frame(matrix(ncol = 0, nrow = nrow(wgt_smc_4)))
results_4$max_to_min <- wgt_smc_4$max_to_min

#number of municipality splits
results_4$nun_mun_split <- num_mun_split_4
results_4$mun_split <- mun_split_4

#check whether there are cases where a municipality is split into more than 2 districts
results_4$multi <-  results_4$nun_mun_split - results_4$mun_split

#number of gun splits
results_4$num_gun_split <- num_gun_split_4
results_4$gun_split <- gun_split_4

#number of koiki renkei area splits
results_4$koiki_split <- koiki_split_4

results_4$index <- 1:nrow(wgt_smc_4)
```
```{r}
# Post-processing: filter out plans with discontiguous districts

#in this case, Aki-ku(Hiroshima-shi; code: 34107) and Aki-gun (code: 34300) must be in the same district to avoid creating discontiguous districts
contiguous_4 <- 1:25000
for(i in 1:25000){
   contiguous_4[i] <- 
     as.integer(pref_smc_plans_4[,i][which(pref_4$gun_code == 34107)] == pref_smc_plans_4[,i][which(pref_4$gun_code == 34300)])
}
results_4$contiguous <- contiguous_4

#Ferry routes connect Kure-shi (34202) to Minami-ku, Hiroshima-shi (34103).
#However, Kure-shi and Minami-ku, Hiroshima-shi are  not connected by land.
#Thus, we must make sure to avoid a situation in which Kure-shi and Minami-ku, Hiroshima-shi both belong to the district that is different from the district Aki-gun(34300) belongs to.
ferry_discontiguity_4 <- 1:25000
for(i in 1:25000){
   ferry_discontiguity_4[i] <- 
     as.integer(
      #We must avoid a situation in which Kure-shi (34202) and Minami-ku, Hiroshima-shi (34103) belong to the same district
      pref_smc_plans_4[,i][which(pref_4$gun_code == 34202)] == pref_smc_plans_4[,i][which(pref_4$gun_code == 34103)]&
      #whereby that district is different from the district Aki-gun (34300) belongs to
      pref_smc_plans_4[,i][which(pref_4$gun_code == 34202)] != pref_smc_plans_4[,i][which(pref_4$gun_code == 34300)]
      )
}
results_4$ferry_discontiguity <- ferry_discontiguity_4
```

### 1.5  Optimal Plan
The optimal plan is the plan that has the smallest max:min ratio out of all plans that do not have discontiguous districts and do not split a municipality into more than 2 districts.
```{r}
functioning_results_0 <- results_0[which(results_0$contiguous == 1 & results_0$ferry_discontiguity == 0), ]
optimal_0 <- functioning_results_0$index[which(functioning_results_0$max_to_min ==
                                         min(functioning_results_0$max_to_min))][1]
results_0[optimal_0,]
```

```{r}
functioning_results_1 <- results_1[which(results_1$contiguous == 1 & results_1$ferry_discontiguity == 0 & results_1$multi == 0), ]
optimal_1 <- functioning_results_1$index[which(functioning_results_1$max_to_min ==
                                         min(functioning_results_1$max_to_min))][1]
results_1[optimal_1,]
```
```{r}
functioning_results_2 <- results_2[which(results_2$contiguous == 1 & results_2$ferry_discontiguity == 0 & results_2$multi == 0), ]
optimal_2 <- functioning_results_2$index[which(functioning_results_2$max_to_min ==
                                         min(functioning_results_2$max_to_min))][1]
results_2[optimal_2,]
```

```{r}
functioning_results_3 <- results_3[which(results_3$contiguous == 1 & results_3$ferry_discontiguity == 0 &results_3$multi == 0), ]
optimal_3 <- functioning_results_3$index[which(functioning_results_3$max_to_min ==
                                         min(functioning_results_3$max_to_min))][1]
results_3[optimal_3,]
```
```{r}
functioning_results_4 <- results_4[which(results_4$contiguous == 1 & results_4$ferry_discontiguity == 0 &results_4$multi == 0), ]
optimal_4 <- functioning_results_4$index[which(functioning_results_4$max_to_min ==
                                         min(functioning_results_4$max_to_min))][1]
results_4[optimal_4,]
```


# 2. Visualize Optimal Plan
## 2.1 0 splits
```{r}
#get data on optimal plan
matrix_optimal_0 <- redist::get_plans_matrix(sim_smc_pref_0 %>% filter(draw == optimal_0))
colnames(matrix_optimal_0) <- "district"
optimal_boundary_0 <- cbind(pref_map_0, as_tibble(matrix_optimal_0))

#get data on gun boundary
gun_boundary <- pref_0 %>%
  filter(gun_code >= (pref_map_0$code[1]%/%1000)* 1000 + 300) %>%
  group_by(gun_code) %>%
  summarise(geometry = sf::st_union(geometry))

#get data on koiki renkei area boundary
koiki_boundary_1 <- pref %>%
  filter(code %in% hiroshima_koiki) %>%
  summarise(geometry = sf::st_union(geometry))

koiki_boundary_2 <- pref %>%
  filter(code %in% bingo_koiki) %>%
  summarise(geometry = sf::st_union(geometry))

koiki_boundary_2 <- pref %>%
  filter(code %in% hiroshima_chuo_koiki) %>%
  summarise(geometry = sf::st_union(geometry))

#map with district data + municipality/gun/koiki-renkei boundary
ggplot() +
  geom_sf(data = optimal_boundary_0, aes(fill = factor(district))) +
  scale_fill_manual(values = c("orange", "green", "blue", "yellow", "brown", "purple")) +
  geom_sf(data = gun_boundary, fill = NA, color = "black", lwd = 1.0) +
  #geom_sf(data = koiki_boundary_1, fill = "plum1", alpha = 0.5, color = "plum1", lwd = 0.2) +
  theme(axis.line = element_blank(), axis.text = element_blank(),
        axis.ticks = element_blank(), axis.title = element_blank(),
        legend.title = element_blank(), legend.position = "None",
        panel.background = element_blank())
```

## 2.2 Allowing Up to 1 Municipality Split
```{r}
#get data on optimal plan
matrix_optimal_1 <- redist::get_plans_matrix(sim_smc_pref_1 %>% filter(draw == optimal_1))
colnames(matrix_optimal_1) <- "district"
optimal_boundary_1 <- cbind(pref_map_1, as_tibble(matrix_optimal_1))

#get data on municipality boundary
mun_boundary <- pref_0 %>%
  group_by(code) %>%
  summarise(geometry = sf::st_union(geometry))

#map with district data + municipality/gun/koiki-renkei boundary
ggplot() +
  geom_sf(data = optimal_boundary_1, aes(fill = factor(district))) +
  scale_fill_manual(values = c("1" = "yellow", "2" = "brown", "3" = "orange", 
                               "4" = "purple", "5" = "green", "6" = "blue")) +
  geom_sf(data = mun_boundary, fill = NA, color = "black", lwd = 0.4) +
  geom_sf(data = gun_boundary, fill = NA, color = "black", lwd = 1.0) +
  theme(axis.line = element_blank(), axis.text = element_blank(),
        axis.ticks = element_blank(), axis.title = element_blank(),
        legend.title = element_blank(), legend.position = "None",
        panel.background = element_blank())
```

## 2.3 Allowing Up to 2 Municipality Splits
```{r}
#get data on optimal plan
matrix_optimal_2 <- redist::get_plans_matrix(sim_smc_pref_2 %>% filter(draw == optimal_2))
colnames(matrix_optimal_2) <- "district"
optimal_boundary_2 <- cbind(pref_map_2, as_tibble(matrix_optimal_2))

#map with district data + municipality/gun/koiki-renkei boundary
ggplot() +
  geom_sf(data = optimal_boundary_2, aes(fill = factor(district))) +
  scale_fill_manual(values = c("1" = "yellow", "2" = "blue", "3" = "orange", 
                               "4" = "brown", "5" = "green", "6" = "purple")) +
  geom_sf(data = mun_boundary, fill = NA, color = "black", lwd = 0.4) +
  geom_sf(data = gun_boundary, fill = NA, color = "black", lwd = 1.0) +
  theme(axis.line = element_blank(), axis.text = element_blank(),
        axis.ticks = element_blank(), axis.title = element_blank(),
        legend.title = element_blank(), legend.position = "None",
        panel.background = element_blank())
```

## 2.4 Allowing Up to 3 Municipality Splits
```{r}
#get data on optimal plan
matrix_optimal_3 <- redist::get_plans_matrix(sim_smc_pref_3 %>% filter(draw == optimal_3))
colnames(matrix_optimal_3) <- "district"
optimal_boundary_3 <- cbind(pref_map_3, as_tibble(matrix_optimal_3))

#map with district data + municipality/gun/koiki-renkei boundary
ggplot() +
  geom_sf(data = optimal_boundary_3, aes(fill = factor(district))) +
  scale_fill_manual(values = c("1" = "orange", "2" = "blue", "3" = "yellow", 
                               "4" = "green", "5" = "brown", "6" = "purple")) +
  geom_sf(data = mun_boundary, fill = NA, color = "black", lwd = 0.4) +
  geom_sf(data = gun_boundary, fill = NA, color = "black", lwd = 1.0) +
  theme(axis.line = element_blank(), axis.text = element_blank(),
        axis.ticks = element_blank(), axis.title = element_blank(),
        legend.title = element_blank(), legend.position = "None",
        panel.background = element_blank())
```


## 2.5 Allowing Up to 4 Municipality Splits
```{r}
#get data on optimal plan
matrix_optimal_4 <- redist::get_plans_matrix(sim_smc_pref_4 %>% filter(draw == optimal_4))
colnames(matrix_optimal_4) <- "district"
optimal_boundary_4 <- cbind(pref_map_4, as_tibble(matrix_optimal_4))

#map with district data + municipality/gun/koiki-renkei boundary
ggplot() +
  geom_sf(data = optimal_boundary_4, aes(fill = factor(district))) +
  scale_fill_manual(values = c("1" = "orange", "2" = "blue", "3" = "green", 
                               "4" = "yellow", "5" = "brown", "6" = "purple")) +
  geom_sf(data = mun_boundary, fill = NA, color = "black", lwd = 0.4) +
  geom_sf(data = gun_boundary, fill = NA, color = "black", lwd = 1.0) +
  theme(axis.line = element_blank(), axis.text = element_blank(),
        axis.ticks = element_blank(), axis.title = element_blank(),
        legend.title = element_blank(), legend.position = "None",
        panel.background = element_blank())
```

# 3. Co-occurrence
## 3.1 Filter Out Plan with Low Max:min Ratio (Top 10%)
```{r}
good_num_0 <-  functioning_results_0 %>%
  arrange(max_to_min) %>%
  slice(1: as.numeric(nsims*0.1)) %>%
  select(index)
good_num_0 <- as.vector(t(good_num_0))
sim_smc_pref_0_good <- sim_smc_pref_0 %>%
  filter(draw %in% good_num_0)
```

## 3.2 Obtain co-occurrence matrix
```{r}
m_co_0 = redist::prec_cooccurrence(sim_smc_pref_0_good, sampled_only=TRUE)
```

## 3.3 Use `cluster::agnes()` to create clusters
```{r}
cl_co_0 = cluster::agnes(m_co_0)
plot(as.dendrogram(cl_co_0)) 
prec_clusters_0 = cutree(cl_co_0, 6) #6: number of clusters
```

## 3.4 Convert data on membership to tibble
```{r}
pref_membership_0 <- as_tibble(as.data.frame(prec_clusters_0))
names(pref_membership_0) <- "membership"
```


## 3.5 Obtain co-occurrence ratio
```{r}
cooc_ratio <- vector(length = length(pref_0$code))
#----define relcomp function--------
relcomp <- function(a, b) {
  comp <- vector()
  for (i in a) {
    if (i %in% a && !(i %in% b)) {
      comp <- append(comp, i)
    }
  }
  return(comp)
}


for (i in 1:length(pref_0$code))
{
  cooc_ratio[i] <- 1 -
    sum(pref_0$pop[relcomp(prefadj_0[[i]]+1,
                              which(prec_clusters_0 == prec_clusters_0[i]))] * m_co_0[i, relcomp(prefadj_0[[i]]+1,
                                                                                                 which(prec_clusters_0 == prec_clusters_0[i]))])/
    sum(pref_0$pop[prefadj_0[[i]]+1] * m_co_0[i, prefadj_0[[i]]+1])
}
```

##3.6 Match membership data with map object
```{r}
pref_0_membership <- cbind(pref_0, cooc_ratio, pref_membership_0)

#sort membership data by group
pref_0_membership_1 <- pref_0_membership %>% dplyr::filter(membership == 1)
pref_0_membership_2 <- pref_0_membership %>% dplyr::filter(membership == 2)
pref_0_membership_3 <- pref_0_membership %>% dplyr::filter(membership == 3)
pref_0_membership_4 <- pref_0_membership %>% dplyr::filter(membership == 4)
pref_0_membership_5 <- pref_0_membership %>% dplyr::filter(membership == 5)
pref_0_membership_6 <- pref_0_membership %>% dplyr::filter(membership == 6)
```

##3.7 Plot
```{r}
ggplot() +
  geom_sf(data = pref_0_membership_1, aes(fill = cooc_ratio), show.legend = FALSE) +
  scale_fill_gradient(low="palegreen", high="green") +

  ggnewscale::new_scale_fill() +
  geom_sf(data = pref_0_membership_2, aes(fill = cooc_ratio), show.legend = FALSE) +
  scale_fill_gradient(low = "skyblue", high = "blue") +

  ggnewscale::new_scale_fill() +
  geom_sf(data = pref_0_membership_3, aes(fill = cooc_ratio), show.legend = FALSE) +
  scale_fill_gradient(low = "lightsalmon", high = "orange") +
  
  ggnewscale::new_scale_fill() +
  geom_sf(data = pref_0_membership_4, aes(fill = cooc_ratio), show.legend = FALSE) +
  scale_fill_gradient(low = "brown1", high = "brown4") +
  
  ggnewscale::new_scale_fill() +
  geom_sf(data = pref_0_membership_5, aes(fill = cooc_ratio), show.legend = FALSE) +
  scale_fill_gradient(low = "purple", high = "purple4") +
  
  ggnewscale::new_scale_fill() +
  geom_sf(data = pref_0_membership_6, aes(fill = cooc_ratio), show.legend = FALSE) +
  scale_fill_gradient(low="yellow", high="yellow3") +
  
  labs(color = "Co-occurrence",
       title = "Co-occurrence Analysis: Plans with Top 10% Max-min Ratio") +
  
  geom_sf(data = gun_boundary, fill = NA, color = "black", lwd = 1.0) +

  theme(legend.box = "vertical",
        legend.title = element_text(color = "black", size = 7),
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        panel.background = element_blank())
```

