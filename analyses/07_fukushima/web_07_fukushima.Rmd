---
title: "福島県 (議員定数：5 → 4)"
description: "アルゴリズムによる衆議院小選挙区の区割り改定案"
date: "`r format(Sys.time(), '%Y/%m/%d')`"
author: "ALARM Japan プロジェクトチーム"
output:
  distill::distill_article:
    css: !expr here::here("alarm_japan.css")
doi: "10.7910/DVN/Z9UKSH"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
options(width = 100)
library(redist)
library(geomander)
library(tidyverse)
library(gt)
library(extrafontdb)
library(Rttf2pt1)

pref_code <- 07
pref_name <- "fukushima"
pref_name_kanji <- "福島県"
```

```{r Manual Entries, include = FALSE}
## Find the coordinates of the 県庁, 
## 政令指定都市の市庁舎 (if there is a 政令指定都市 different from 県庁所在地)
## and 中核市の市庁舎 (if there is a 中核市 different from 県庁所在地)
cities <- data.frame(longitude = c(140.47468, 140.35964, 140.88762), 
                     latitude = c(37.76075, 37.40038, 37.05049),
                     names = c("福島市", "郡山市", "いわき市"))
cities <- sf::st_as_sf(cities, coords = c("longitude", "latitude"), 
                       crs = 4612)

## Information about splits
sq_mun_splits_name <- "" 
sq_gun_splits_name <- "西白河郡"
sq_koiki_splits_name <- "こおりやま広域連携中枢都市圏、しらかわ地域定住自立圏"
split_1_name <- "いわき市"

## Color Palette
PAL <- c( '#6D9537', '#DCAD35','#7F4E28', '#364B7F', '#2A4E45', '#9A9BB9')
```

```{r load data, include=FALSE}
load(here::here(paste("data-out/pref/",
            as.character(pref_code),
            "_",
            as.character(pref_name),
            "_data",
            ".Rdata",
            sep = "")))
```

```{r table summary}
# summary table
sim_gun_split <- ifelse(is.null(results_0$num_gun_split[optimal_0]), 0, results_0$num_gun_split[optimal_0])

table_summary <- dplyr::tribble(
  ~category, ~status_quo, ~split_0, 
  "県内較差", sq_max_to_min, results_0$max_to_min[optimal_0], 
  "改善率", NA, (sq_max_to_min - results_0$max_to_min[optimal_0])/(sq_max_to_min - 1), 
  "選挙区数", ndists_old, ndists_new,
  "市区町村の分割", sq_mun_splits, 0, 
  "郡の分割", sq_gun_splits, sim_gun_split, 
  "広域連携地域の分割", sq_koiki_splits, results_0$koiki_split[optimal_0], 
) 

table_summary %>% 
  gt(rowname_col = "category") %>% 
  fmt_number(
    columns = everything(),
    rows = 1,
    decimals = 3
  ) %>% 
  fmt_percent(
    columns = everything(),
    rows = 2,
    decimals = 1
  ) %>% 
  fmt_missing(
    columns = 2,
    rows = 2,
    missing_text = "-"
  ) %>% 
  tab_row_group(
    label = md("**選挙区の状況**"),
    rows = 3:6
  ) %>%   
  tab_row_group(
    label = md("**1票の格差**"),
    rows = 1:2
  ) %>% 
  tab_spanner(
    label = "現行",
    columns = status_quo
  ) %>% 
  tab_spanner(
    label = "アルゴリズムの提案",
    columns = c(split_0)
  ) %>% 
  cols_label(
    status_quo = "",
    split_0 = "市区町村の分割無し"
  ) %>% 
  cols_align(
    align = "center",
    columns = 2:3
  ) %>% 
  cols_width(
    status_quo ~ pct(37.5),
    split_0 ~ pct(37.5)
  ) %>% 
  tab_header(
    title = md(paste("**", pref_name_kanji, "**", sep = "")),
    subtitle = paste("人口：", format(sum(pref$pop), big.mark = ",", scientific = FALSE), "人（2020年）")
  ) %>% 
  tab_footnote(
    footnote = sq_gun_splits_name,
    locations = cells_body(
      columns = 2,
      rows = 5
    ) 
  )%>% 
 tab_footnote(
    footnote = sq_koiki_splits_name,
    locations = cells_body(
      columns = 2:3,
      rows = 6
    ) 
  ) %>% 
  opt_footnote_marks(marks = "letters") %>% 
  tab_style(
    style = list(
      cell_text(weight = "bold")
      ),
    locations = cells_body(
      columns = 2:3,
      rows = 1
    ) 
  ) 
```

# 現行の区割り 
```{r status quo plan, warning=FALSE, message = FALSE}
# Set Colors for Plot
if(ndists_old > 6){
  sq_pref_map <- sq_pref %>% 
    mutate(pop = 1) %>% # only for plotting purpose
    redist_map(ndists = nrow(sq_pref)) %>% 
    mutate(color = redist:::color_graph(.$adj, as.integer(.$ku)))
}else{
  sq_pref_map <- sq_pref %>% 
    mutate(color = ku)
}
# Plot Map
ggplot() +
  geom_sf(data = sq_pref_map, aes(fill = factor(color)), color = NA) +
  scale_fill_manual(values = PAL, guide = "none") +
  
  geom_sf(data = boundary_0, aes(color = type), show.legend = "line", 
          fill = NA, lwd = 0.4) +
  scale_color_manual(values = c("grey60", "grey30")) +
  
  geom_sf(data = cities, size = 2, shape = 21, fill = "red") +
  geom_sf_text(data = cities, aes(label = names), 
               color = c("black", "black", "white"), size = 3,
              nudge_x = c(-0.03, -0.03, -0.03), # adjust the position of the labels
              nudge_y = c(-0.03, -0.03, -0.03), # adjust the position of the labels
              family = "HiraginoSans-W3") +
  
  ggthemes::theme_map(base_family = "HiraginoSans-W3") +
  theme(legend.position = "right", legend.title = element_blank())
```

# アルゴリズムの提案
アルゴリズムが提案した`r format(nsims, big.mark = ",")`案のうち、有効な案の中で、一票の格差が最小のもの

### 市区町村を分割しない区割り案
一票の格差 : `r round(results_0[optimal_0,]$max_to_min, digits = 3) `

```{r optimal plan (0 split)}
redist::redist.plot.plans(sim_smc_pref_0, optimal_0, pref_map_0) +
  labs(title = element_blank())+
  scale_fill_manual(values = PAL, guide = "none") + 
  geom_sf(data = boundary_0, aes(color = type), show.legend = "line", 
          fill = NA, lwd = 0.4) +
  scale_color_manual(values = c("grey60", "grey30")) +
  
  geom_sf(data = cities, size = 2, shape = 21, fill = "red") +
  geom_sf_text(data = cities, aes(label = names), 
               color = c("white", "black", "white"), size = 3,
              nudge_x = c(-5000, -5000, -5000), # adjust the position of the labels
              nudge_y = c(-5000, -5000, -5000), # adjust the position of the labels
              family = "HiraginoSans-W3") +
  
  ggthemes::theme_map(base_family = "HiraginoSans-W3") +
  theme(legend.position = "right", legend.title = element_blank())
```

# 共起分析
* アルゴリズム設定
  + 市区町村の分割無し
  + 飛び地を含む案を棄却
  + 一票の格差が下位10％の案を抽出
* 読み取り方  
地図上の市区町村の色が
  + 同じ → 同じ選挙区に属する傾向が強い
  + 同じ かつ 濃い → 隣接する市区町村と同じ選挙区に属する傾向が強い

```{r co-occurrence, warning = FALSE}
# Match membership data with map object
if(ndists_new > 6){
  pref_0_cooc <- cbind(pref_map_0, cooc_ratio, pref_membership_0) %>% 
    mutate(color = redist:::color_graph(.$adj, as.integer(.$membership)))
} else{
  pref_0_cooc <- cbind(pref_map_0, cooc_ratio, pref_membership_0) %>% 
    mutate(color = .$membership)
}

## Reorder Color Palette
PAL <- c('#6D9537', '#364B7F', '#DCAD35','#7F4E28', '#2A4E45', '#9A9BB9')

# Co-occurrence plot
ggplot() +
  geom_sf(data = pref_0_cooc, aes(fill = as.factor(color), alpha = cooc_ratio), show.legend = FALSE) +
  scale_fill_manual(values = PAL, guide = "none") + 
  scale_alpha_continuous(range = c(min(cooc_ratio), max(cooc_ratio)), guide = "none") + 
  
  geom_sf(data = boundary_0, aes(color = type), show.legend = "line", 
          fill = NA, lwd = 0.4) +
  scale_color_manual(values = c("grey60", "grey30")) +
  
  geom_sf(data = cities, size = 2, shape = 21, fill = "red") +
  geom_sf_text(data = cities, aes(label = names), 
               color = c("white" ,"black", "black"), size = 3,
              nudge_x = c(-5000, -5000, -5000), # adjust the position of the labels
              nudge_y = c(-5000, -5000, -5000), # adjust the position of the labels
              family = "HiraginoSans-W3") +

  ggthemes::theme_map(base_family = "HiraginoSans-W3") +
  theme(legend.position = "right", legend.title = element_blank())
```

# アルゴリズム設定

* 各選挙区の人口 : (県内の総人口 / 選挙区数) ±10%
* アルゴリズムが導出する案の総数 : `r format(nsims, big.mark = ",")`
* 有効な区割り案（飛び地を生じさせない）の数 : 
    + 市区町村の分割無し : `r format(length(functioning_results_0$index), big.mark = ",", scientific = FALSE)`  
* 有効な案から一票の格差が最小の区割り案を選定

### 県特有の設定  

* 最大市区町村の分割を許容する区割り案は作成しない
    + 本プロジェクトでは市区町村の分割は平成の大合併前の境界を用いる
    + 分割対象である人口最大の市区町村（いわき市）は、1966年以降は市区町村合併をしていない
    + よって、本プロジェクトではいわき市を分割しない
